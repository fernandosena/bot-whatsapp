<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filtro de Mensagens - Status de Envio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-links a {
            text-decoration: none;
            padding: 10px 20px;
            background: #25D366;
            color: white;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-links a:hover {
            background: #128C7E;
            transform: translateY(-2px);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        .stat-card.total .value { color: #667eea; }
        .stat-card.enviado .value { color: #48bb78; }
        .stat-card.nao-enviado .value { color: #ed8936; }
        .stat-card.bloqueado .value { color: #f56565; }

        .filters {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .filters h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #25D366;
        }

        .status-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .status-filter {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-weight: 600;
        }

        .status-filter:hover {
            border-color: #25D366;
            transform: translateY(-2px);
        }

        .status-filter.active {
            border-color: #25D366;
            background: #f0fdf4;
        }

        .status-filter.all { color: #667eea; }
        .status-filter.enviado { color: #48bb78; }
        .status-filter.nao-enviado { color: #ed8936; }
        .status-filter.bloqueado { color: #f56565; }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #25D366;
            color: white;
        }

        .btn-primary:hover {
            background: #128C7E;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.4);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        .table-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #25D366;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:hover {
            background: #f7fafc;
        }

        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-enviado {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-nao-enviado {
            background: #feebc8;
            color: #7c2d12;
        }

        .badge-bloqueado {
            background: #fed7d7;
            color: #742a2a;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #25D366;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            background: #25D366;
            color: white;
            border-color: #25D366;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: #25D366;
            color: white;
            border-color: #25D366;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h2 {
            margin: 0;
            color: #333;
        }

        .close-btn {
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 2px solid #e0e0e0;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 150px;
        }

        textarea:focus {
            outline: none;
            border-color: #25D366;
        }

        .info-box {
            background: #e6f7ff;
            border-left: 4px solid #1890ff;
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
            font-size: 14px;
        }

        .success-box {
            background: #f0fdf4;
            border-left: 4px solid #48bb78;
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
            font-size: 14px;
        }

        .warning-box {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
            font-size: 14px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .bulk-actions {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bulk-actions.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>üìä Filtro de Mensagens</h1>
                <p style="color: #666; margin-top: 10px;">Visualize quais n√∫meros j√° receberam mensagens</p>
            </div>
            <div class="nav-links">
                <a href="/">üè† In√≠cio</a>
                <a href="/whatsapp">üí¨ WhatsApp</a>
            </div>
        </div>

        <!-- Estat√≠sticas -->
        <div class="stats">
            <div class="stat-card total">
                <h3>Total de Empresas</h3>
                <div class="value" id="stat-total">0</div>
            </div>
            <div class="stat-card enviado">
                <h3>‚úÖ Mensagens Enviadas</h3>
                <div class="value" id="stat-enviado">0</div>
            </div>
            <div class="stat-card nao-enviado">
                <h3>‚è≥ N√£o Enviadas</h3>
                <div class="value" id="stat-nao-enviado">0</div>
            </div>
            <div class="stat-card bloqueado">
                <h3>üö´ Bloqueadas</h3>
                <div class="value" id="stat-bloqueado">0</div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters">
            <h2>üîç Filtros</h2>

            <!-- Filtros de Status -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600;">Status de Envio:</label>
                <div class="status-filters">
                    <div class="status-filter all active" onclick="setStatusFilter('')" data-status="">
                        üìã Todos
                    </div>
                    <div class="status-filter enviado" onclick="setStatusFilter('enviado')" data-status="enviado">
                        ‚úÖ Enviados
                    </div>
                    <div class="status-filter nao-enviado" onclick="setStatusFilter('nao_enviado')" data-status="nao_enviado">
                        ‚è≥ N√£o Enviados
                    </div>
                    <div class="status-filter bloqueado" onclick="setStatusFilter('bloqueado')" data-status="bloqueado">
                        üö´ Bloqueados
                    </div>
                </div>
            </div>

            <!-- Outros Filtros -->
            <div class="form-row">
                <div class="form-group">
                    <label>Buscar</label>
                    <input type="text" id="search" placeholder="Nome ou telefone">
                </div>
                <div class="form-group">
                    <label>Setor</label>
                    <select id="filter-setor">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cidade</label>
                    <select id="filter-cidade">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Campanha</label>
                    <select id="filter-campanha">
                        <option value="">Todas</option>
                    </select>
                </div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="loadEmpresas()">üîç Aplicar Filtros</button>
                <button class="btn btn-success" onclick="exportExcel()">üì• Exportar Excel</button>
                <button class="btn btn-secondary" onclick="resetFilters()">üîÑ Limpar Filtros</button>
            </div>
        </div>

        <!-- Tabela -->
        <div class="table-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>üìã Empresas e Status de Envio</h2>
                <div id="loading-indicator" style="display: none;">
                    <div class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></div>
                </div>
            </div>

            <!-- A√ß√µes em Massa -->
            <div id="bulk-actions-bar" class="bulk-actions hidden">
                <div>
                    <span id="selected-count" style="font-weight: 600; color: #333;">0 selecionados</span>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="criarCampanha()">
                        üì§ Criar Campanha WhatsApp
                    </button>
                    <button class="btn btn-secondary" onclick="clearSelection()">
                        ‚úñÔ∏è Limpar Sele√ß√£o
                    </button>
                </div>
            </div>

            <div id="table-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Carregando dados...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Criar Campanha -->
    <div id="campaign-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì§ Criar Campanha WhatsApp</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-box">
                    <strong>‚ÑπÔ∏è Informa√ß√£o:</strong> Voc√™ est√° criando uma campanha para <span id="campaign-count">0</span> empresas selecionadas.
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Nome da Campanha:</label>
                    <input type="text" id="campaign-name" placeholder="Ex: Promo√ß√£o Natal 2025" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Mensagem:</label>
                    <textarea id="campaign-message" placeholder="Digite a mensagem que ser√° enviada...

üí° Dica: Use vari√°veis:
{nome} - Nome da empresa
{setor} - Setor da empresa
{cidade} - Cidade da empresa"></textarea>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Delay entre mensagens (segundos):</label>
                    <input type="number" id="campaign-delay" value="30" min="10" max="300" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        Recomendado: 30-60 segundos para evitar bloqueios
                    </small>
                </div>

                <div class="warning-box">
                    <strong>‚ö†Ô∏è Importante:</strong>
                    <ul style="margin: 8px 0 0 20px; padding: 0;">
                        <li>Certifique-se de estar conectado ao WhatsApp</li>
                        <li>N√£o feche o navegador durante o envio</li>
                        <li>O processo pode levar v√°rios minutos</li>
                    </ul>
                </div>

                <div id="campaign-status" style="display: none; margin-top: 15px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" id="btn-start-campaign" onclick="startCampaign()">
                    üöÄ Iniciar Campanha
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const socket = io();
        let currentStatusFilter = '';
        let allEmpresas = [];
        let selectedEmpresas = new Set();

        // Carregar estat√≠sticas
        async function loadStats(empresas) {
            const total = empresas.length;
            const enviados = empresas.filter(e => e.status_envio === 'enviado').length;
            const naoEnviados = empresas.filter(e => e.status_envio === 'nao_enviado').length;
            const bloqueados = empresas.filter(e => e.status_envio === 'bloqueado').length;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-enviado').textContent = enviados;
            document.getElementById('stat-nao-enviado').textContent = naoEnviados;
            document.getElementById('stat-bloqueado').textContent = bloqueados;
        }

        // Carregar empresas
        async function loadEmpresas() {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.style.display = 'block';

            const search = document.getElementById('search').value;
            const setor = document.getElementById('filter-setor').value;
            const cidade = document.getElementById('filter-cidade').value;
            const campanhaId = document.getElementById('filter-campanha').value;

            const params = new URLSearchParams({
                search,
                setor,
                cidade,
                status_envio: currentStatusFilter
            });

            if (campanhaId) {
                params.append('campanha_id', campanhaId);
            }

            try {
                const response = await fetch(`/api/empresas/com-status-envio?${params}`);
                const data = await response.json();

                allEmpresas = data.empresas;
                loadStats(allEmpresas);
                renderTable(allEmpresas);
            } catch (error) {
                console.error('Erro ao carregar empresas:', error);
                document.getElementById('table-content').innerHTML = `
                    <div class="empty-state">
                        <h3>‚ùå Erro ao carregar dados</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        // Renderizar tabela
        function renderTable(empresas) {
            const tableContent = document.getElementById('table-content');

            if (empresas.length === 0) {
                tableContent.innerHTML = `
                    <div class="empty-state">
                        <h3>Nenhuma empresa encontrada</h3>
                        <p>Tente ajustar os filtros ou adicione mais empresas ao sistema</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
                            <th>Nome</th>
                            <th>Setor</th>
                            <th>Cidade</th>
                            <th>WhatsApp</th>
                            <th>Status</th>
                            <th>Data de Envio</th>
                            <th>Detalhes</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            empresas.forEach(empresa => {
                const statusBadge = getStatusBadge(empresa.status_envio);
                const dataEnvio = empresa.data_envio
                    ? new Date(empresa.data_envio).toLocaleString('pt-BR')
                    : '-';

                const detalhes = getDetalhes(empresa);
                const isChecked = selectedEmpresas.has(empresa.id) ? 'checked' : '';

                html += `
                    <tr>
                        <td><input type="checkbox" class="empresa-checkbox" value="${empresa.id}" ${isChecked} onchange="updateSelection()"></td>
                        <td><strong>${empresa.nome}</strong></td>
                        <td>${empresa.setor}</td>
                        <td>${empresa.cidade}</td>
                        <td>${empresa.whatsapp || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>${dataEnvio}</td>
                        <td>${detalhes}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            tableContent.innerHTML = html;
        }

        // Obter badge de status
        function getStatusBadge(status) {
            switch(status) {
                case 'enviado':
                    return '<span class="badge badge-enviado">‚úÖ Enviado</span>';
                case 'nao_enviado':
                    return '<span class="badge badge-nao-enviado">‚è≥ N√£o Enviado</span>';
                case 'bloqueado':
                    return '<span class="badge badge-bloqueado">üö´ Bloqueado</span>';
                default:
                    return '<span class="badge">‚ùì Desconhecido</span>';
            }
        }

        // Obter detalhes
        function getDetalhes(empresa) {
            if (empresa.status_envio === 'enviado') {
                const statusMsg = empresa.status_msg === 'sucesso'
                    ? '‚úÖ Sucesso'
                    : '‚ùå ' + (empresa.erro || 'Erro');
                return `<span class="tooltip">‚ÑπÔ∏è <span class="tooltiptext">${statusMsg}</span></span>`;
            } else if (empresa.status_envio === 'bloqueado') {
                const motivo = empresa.motivo_bloqueio || 'Sem motivo especificado';
                return `<span class="tooltip">üö´ <span class="tooltiptext">${motivo}</span></span>`;
            } else {
                return `<span class="tooltip">‚è≥ <span class="tooltiptext">Aguardando envio</span></span>`;
            }
        }

        // Definir filtro de status
        function setStatusFilter(status) {
            currentStatusFilter = status;

            // Atualizar UI
            document.querySelectorAll('.status-filter').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector(`[data-status="${status}"]`).classList.add('active');

            // Recarregar dados
            loadEmpresas();
        }

        // Resetar filtros
        function resetFilters() {
            document.getElementById('search').value = '';
            document.getElementById('filter-setor').value = '';
            document.getElementById('filter-cidade').value = '';
            document.getElementById('filter-campanha').value = '';
            currentStatusFilter = '';

            document.querySelectorAll('.status-filter').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector('[data-status=""]').classList.add('active');

            loadEmpresas();
        }

        // Exportar para Excel
        function exportExcel() {
            const search = document.getElementById('search').value;
            const setor = document.getElementById('filter-setor').value;
            const cidade = document.getElementById('filter-cidade').value;
            const campanhaId = document.getElementById('filter-campanha').value;

            const params = new URLSearchParams({
                search,
                setor,
                cidade,
                status_envio: currentStatusFilter
            });

            if (campanhaId) {
                params.append('campanha_id', campanhaId);
            }

            window.location.href = `/api/export/mensagens-excel?${params}`;
        }

        // Carregar filtros (setores, cidades, campanhas)
        async function loadFilters() {
            // Setores
            try {
                const setoresResponse = await fetch('/api/setores');
                const setores = await setoresResponse.json();
                const setorSelect = document.getElementById('filter-setor');
                setores.forEach(setor => {
                    const option = document.createElement('option');
                    option.value = setor;
                    option.textContent = setor;
                    setorSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar setores:', error);
            }

            // Cidades
            try {
                const cidadesResponse = await fetch('/api/cidades');
                const cidades = await cidadesResponse.json();
                const cidadeSelect = document.getElementById('filter-cidade');
                cidades.forEach(cidade => {
                    const option = document.createElement('option');
                    option.value = cidade;
                    option.textContent = cidade;
                    cidadeSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar cidades:', error);
            }

            // Campanhas
            try {
                const campanhasResponse = await fetch('/api/whatsapp/campaigns');
                const campanhas = await campanhasResponse.json();
                const campanhaSelect = document.getElementById('filter-campanha');
                campanhas.forEach(campanha => {
                    const option = document.createElement('option');
                    option.value = campanha.id;
                    option.textContent = `${campanha.nome} (ID: ${campanha.id})`;
                    campanhaSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar campanhas:', error);
            }
        }

        // ==================== FUN√á√ïES DE SELE√á√ÉO EM MASSA ====================

        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.empresa-checkbox');

            selectedEmpresas.clear();

            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
                if (selectAll.checked) {
                    selectedEmpresas.add(parseInt(cb.value));
                }
            });

            updateSelection();
        }

        function updateSelection() {
            const checkboxes = document.querySelectorAll('.empresa-checkbox');
            selectedEmpresas.clear();

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    selectedEmpresas.add(parseInt(cb.value));
                }
            });

            const count = selectedEmpresas.size;
            const bulkActions = document.getElementById('bulk-actions-bar');
            const selectedCount = document.getElementById('selected-count');

            if (count > 0) {
                bulkActions.classList.remove('hidden');
                selectedCount.textContent = `${count} selecionado${count > 1 ? 's' : ''}`;
            } else {
                bulkActions.classList.add('hidden');
            }
        }

        function clearSelection() {
            selectedEmpresas.clear();
            const checkboxes = document.querySelectorAll('.empresa-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            document.getElementById('select-all').checked = false;
            updateSelection();
        }

        // ==================== FUN√á√ïES DE CAMPANHA ====================

        function criarCampanha() {
            if (selectedEmpresas.size === 0) {
                alert('‚ö†Ô∏è Selecione pelo menos uma empresa para criar a campanha!');
                return;
            }

            // Atualizar contador no modal
            document.getElementById('campaign-count').textContent = selectedEmpresas.size;

            // Gerar nome padr√£o
            const now = new Date();
            const defaultName = `Campanha ${now.toLocaleDateString('pt-BR')} ${now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}`;
            document.getElementById('campaign-name').value = defaultName;

            // Abrir modal
            document.getElementById('campaign-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('campaign-modal').classList.remove('active');
            document.getElementById('campaign-status').style.display = 'none';
            document.getElementById('campaign-status').innerHTML = '';
        }

        async function startCampaign() {
            const campanhaName = document.getElementById('campaign-name').value.trim();
            const mensagem = document.getElementById('campaign-message').value.trim();
            const delay = parseInt(document.getElementById('campaign-delay').value);

            // Valida√ß√µes
            if (!campanhaName) {
                alert('‚ö†Ô∏è Digite um nome para a campanha!');
                return;
            }

            if (!mensagem) {
                alert('‚ö†Ô∏è Digite uma mensagem para enviar!');
                return;
            }

            if (delay < 10 || delay > 300) {
                alert('‚ö†Ô∏è O delay deve ser entre 10 e 300 segundos!');
                return;
            }

            // Verificar se est√° conectado ao WhatsApp
            try {
                const statusResponse = await fetch('/api/whatsapp/session/status');
                const statusData = await statusResponse.json();

                if (!statusData.active || !statusData.logged_in) {
                    alert('‚ùå Voc√™ precisa estar conectado ao WhatsApp!\n\nV√° para a p√°gina /whatsapp e clique em "Conectar ao WhatsApp".');
                    return;
                }
            } catch (error) {
                console.error('Erro ao verificar status WhatsApp:', error);
                alert('‚ùå Erro ao verificar conex√£o com WhatsApp. Verifique se o servidor est√° rodando.');
                return;
            }

            // Desabilitar bot√£o
            const btnStart = document.getElementById('btn-start-campaign');
            btnStart.disabled = true;
            btnStart.textContent = '‚è≥ Iniciando...';

            // Mostrar status
            const statusDiv = document.getElementById('campaign-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = `
                <div class="info-box">
                    <div class="spinner" style="display: inline-block; margin-right: 10px;"></div>
                    <strong>Iniciando campanha...</strong>
                </div>
            `;

            try {
                // Converter Set para Array
                const empresasIds = Array.from(selectedEmpresas);

                // Enviar via WebSocket
                socket.emit('send_whatsapp', {
                    empresas_ids: empresasIds,
                    mensagem: mensagem,
                    delay: delay,
                    campanha_nome: campanhaName
                });

                // Aguardar resposta
                statusDiv.innerHTML = `
                    <div class="success-box">
                        <strong>‚úÖ Campanha iniciada!</strong><br>
                        Acompanhe o progresso na p√°gina <a href="/whatsapp" target="_blank">WhatsApp</a>
                    </div>
                `;

                // Fechar modal ap√≥s 3 segundos
                setTimeout(() => {
                    closeModal();
                    clearSelection();
                    loadEmpresas(); // Recarregar para atualizar status
                }, 3000);

            } catch (error) {
                console.error('Erro ao iniciar campanha:', error);
                statusDiv.innerHTML = `
                    <div class="warning-box">
                        <strong>‚ùå Erro ao iniciar campanha:</strong><br>
                        ${error.message}
                    </div>
                `;
                btnStart.disabled = false;
                btnStart.textContent = 'üöÄ Iniciar Campanha';
            }
        }

        // ==================== WEBSOCKET EVENTS ====================

        socket.on('connect', () => {
            console.log('‚úÖ WebSocket conectado!');
        });

        socket.on('disconnect', () => {
            console.log('‚ùå WebSocket desconectado!');
        });

        socket.on('whatsapp_status', (data) => {
            console.log('WhatsApp Status:', data);
        });

        socket.on('whatsapp_progress', (data) => {
            console.log('WhatsApp Progress:', data);
            // Atualizar tabela para mostrar novos envios
            if (data.current % 5 === 0) { // Atualizar a cada 5 envios
                loadEmpresas();
            }
        });

        socket.on('whatsapp_complete', (data) => {
            console.log('WhatsApp Complete:', data);
            alert(`‚úÖ Campanha conclu√≠da!\n\nTotal: ${data.total}\nSucesso: ${data.success}\nFalhas: ${data.failed}`);
            loadEmpresas();
        });

        socket.on('whatsapp_error', (data) => {
            console.error('WhatsApp Error:', data);
            alert('‚ùå Erro: ' + data.message);
        });

        // ==================== INICIALIZA√á√ÉO ====================

        // Inicializar
        loadFilters();
        loadEmpresas();

        // Auto-refresh a cada 30 segundos
        setInterval(() => {
            loadEmpresas();
        }, 30000);
    </script>
</body>
</html>
